---

- name: Install dependencies
  apt: name={{ item }} state=present update_cache=yes cache_valid_time=3600
  with_items:
    - make
    - gcc
    - g++
    - libicu-dev
    - libssl-dev
    - libxml2-dev
    - libcurl4-openssl-dev
    - libjpeg-dev
    - libvpx-dev
    - libpng12-dev
    - libfreetype6-dev
    - libc-client2007e-dev
    - libkrb5-dev
    - libmcrypt-dev
    - libxslt1-dev
    - libbz2-dev
    - automake
    - autoconf
    - pkg-config
  become: yes

- name: Fetch .deb
  get_url: url=https://ftp.weheartwebsites.de/debian/jessie/php5-fpm_{{ php_version }}_amd64.deb dest=/tmp/php5-fpm_{{ php_version }}_amd64.deb

- name: Install .deb
  apt: deb=/tmp/php5-fpm_{{ php_version }}_amd64.deb
  become: yes

- name: Create folders
  file: state=directory mode=0755 recurse=yes path={{ item }}
  with_items:
  - /etc/php5/fpm/conf.d
  - /var/www
  - /var/log/php-fpm
  become: yes

- name: Create php.ini
  copy: src=php.ini dest=/etc/php5/fpm/php.ini mode=0644
  become: yes

- name: Add logrotate config
  copy: src=logrotate dest=/etc/logrotate.d/php-fpm mode=0644
  become: yes

- name: Add fpm config
  copy: force=no src=php-fpm.conf dest=/etc/php-fpm.conf
  become: yes

- name: Add php-fpm.service
  copy: src=php-fpm.service dest=/lib/systemd/system/php-fpm.service mode=0644
  become: yes

- name: systemd reload
  command: systemctl daemon-reload
  become: yes

- name: enable php-fpm.service
  command: systemctl enable php-fpm
  become: yes

#- name: start php-fpm
#  command: systemctl start php-fpm
#  become: yes